[{"id":"9d2a7d201d1ab423","type":"tab","label":"FLOOD - Distance Sensor","disabled":false,"info":"","env":[]},{"id":"aabbaecce1b00e2a","type":"tab","label":"Camera Snapshoot","disabled":false,"info":"","env":[]},{"id":"b0eb2326195c59f2","type":"tab","label":"Speaker","disabled":true,"info":"","env":[]},{"id":"d3dfdfd513fb0aa2","type":"tab","label":"Solar Battery Status","disabled":false,"info":""},{"id":"9071ee17a216293a","type":"tab","label":"Tipping Sensor","disabled":false,"info":"","env":[]},{"id":"8f1bccb954c87175","type":"group","z":"d3dfdfd513fb0aa2","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["0870edf5488db2a6","f69ef20e49fd5e67","ae3ca7f3c39fa801"],"x":74,"y":119,"w":532,"h":82},{"id":"9b60db2e6429cd60","type":"group","z":"d3dfdfd513fb0aa2","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["49e26240e82539d0","ff4e245b16e85dab","5cfb238b3a200525","5f7aa11225841d0b","b2f915bd6db41bb9","18b80fe4fca895af"],"x":74,"y":19,"w":1092,"h":82},{"id":"1bbb998942558785","type":"group","z":"d3dfdfd513fb0aa2","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["7708ede44e016d0a","a01ae8ea72715992","e563708f3023885b","eec3995c4100cde7","80565d49ed58925c","1be0298cc11e5371"],"x":74,"y":439,"w":472,"h":202},{"id":"8d52cfa95701d1f6","type":"group","z":"aabbaecce1b00e2a","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["665e5d2798cef93b","d6b682e56e47c08c"],"x":34,"y":259,"w":492,"h":82},{"id":"bb0cc219db80aa46","type":"group","z":"aabbaecce1b00e2a","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["91c8c9203ef24cc4","2a7dcb147e1bce7d","c3ac1ee5c473a524","27c4b540989b8bb4","7d08364daae97b02","65e5bea195d79742","7c3771ed37a25f87","8399c02ec7e84cd0"],"x":34,"y":39,"w":972,"h":182},{"id":"c1f924b2eff6c07a","type":"group","z":"b0eb2326195c59f2","name":"Manual Test","style":{"label":true},"nodes":["1","a1d841602e6b1968"],"x":34,"y":19,"w":492,"h":82},{"id":"89f6554eadeaf202","type":"group","z":"b0eb2326195c59f2","name":"Speaker Logic","style":{"label":true},"nodes":["8ae21ac7dbe4b582","7d23a6db0409c5b3","fa2f7ffd6472b54e","ee66ed6c42a9719c","71664a156fed443c","9aec2f9041b3fedc","06761c5803b7da94","c98f629e0adeb021","3bef8afbac187647","d0965ccf1ebc3a65","03d7fbb3a4decebb","970b04d56e4d5a7b","4d69b9971b187965","15a7048efb16c6a6","2948eb0d9e3c819f","c4e364564139d2b4","98bb99a91bc910d2","51a3da1b50ecd7b1"],"x":34,"y":119,"w":952,"h":482},{"id":"109a5214842acafe","type":"group","z":"9071ee17a216293a","name":"Rain Logic v2","style":{"label":true},"nodes":["5758f65c54c6980e","30eaf86bb2bab5c7","5c1390e8081212b4","678bf8127f6fc8e5","319c1fe4768ca6de","0778cb410aee5bbe","3caa94c6a1b78abf","c76ddac70a4b7e18","a8fbdcd184af7480"],"x":54,"y":39,"w":1112,"h":142},{"id":"6fa4ad38fcfa7f17","type":"group","z":"9d2a7d201d1ab423","name":"Distance Sensor Logic","style":{"label":true},"nodes":["6c9e1050b3cd3fd6","ee03dcdf555bcf10","0d777f479bc1c9e3","a18495e7155e3671","c45fd1d35a67803e"],"x":34,"y":39,"w":672,"h":122},{"id":"14054665f49de7d6","type":"group","z":"9d2a7d201d1ab423","name":"Ping Logic","style":{"label":true},"nodes":["f1309305071ffa96","4e897a56a380edf2","6e6209396685e6e6","ab40f0da5b7d3c65","d4c077d82e686833","fd9c97d92befe581","b7e957d06335c629"],"x":34,"y":179,"w":772,"h":162},{"id":"7459e1c0f90208e3","type":"serial-port","z":"d3dfdfd513fb0aa2","name":"","serialport":"/dev/ttyS0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"200","bin":"bin","out":"time","addchar":"","responsetimeout":"10000"},{"id":"9e490f20ec5dd3a7","type":"serial-port","name":"","serialport":"/dev/ttyS3","serialbaud":"4800","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"0","bin":"bin","out":"time","addchar":"","responsetimeout":"10000"},{"id":"ad38133a844d12e3","type":"mqtt-broker","name":"cloud.lightsol.net","broker":"cloud.lightsol.net","port":1883,"clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":60,"cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"c211b55193ae2e61","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"2d855a26519f9f93","type":"ui_tab","name":"Camera","icon":"camera","disabled":false,"hidden":false},{"id":"e183b56a98787c57","type":"ui_group","name":"Milesight Snapshot","tab":"2d855a26519f9f93","order":1,"disp":true,"width":"8","collapse":false},{"id":"990b98dcc7b2506e","type":"serial-port","name":"","serialport":"/dev/ttyUSB0","serialbaud":"57600","databits":8,"parity":"none","stopbits":1,"waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\n","bin":"false","out":"char","addchar":"","responsetimeout":10000},{"id":"ff09cb3.af7d2b8","type":"mqtt-broker","name":"134.209.100.187 - cloud.lightsol.net","broker":"134.209.100.187","port":"1883","clientid":"","autoConnect":true,"usetls":false,"compatmode":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"18a66f10fd39778f","type":"serial-port","name":"","serialport":"/dev/ttyUSB0","serialbaud":"57600","databits":8,"parity":"none","stopbits":1,"waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\n","bin":"false","out":"char","addchar":"","responsetimeout":10000},{"id":"9799330f7dde46c8","type":"mqtt out","z":"9d2a7d201d1ab423","name":"","topic":"flood/water/level","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"ff09cb3.af7d2b8","x":930,"y":260,"wires":[]},{"id":"6c9e1050b3cd3fd6","type":"serial in","z":"9d2a7d201d1ab423","g":"6fa4ad38fcfa7f17","name":"","serial":"18a66f10fd39778f","x":130,"y":80,"wires":[["0d777f479bc1c9e3","a18495e7155e3671","c45fd1d35a67803e"]]},{"id":"f1309305071ffa96","type":"switch","z":"9d2a7d201d1ab423","g":"14054665f49de7d6","name":"Open/Close Decision","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":260,"wires":[["4e897a56a380edf2"],["6e6209396685e6e6"]]},{"id":"4e897a56a380edf2","type":"change","z":"9d2a7d201d1ab423","g":"14054665f49de7d6","name":"Send OPEN","rules":[{"t":"set","p":"topic","pt":"msg","to":"control","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"open","tot":"str"}],"x":550,"y":240,"wires":[["fd9c97d92befe581"]]},{"id":"6e6209396685e6e6","type":"change","z":"9d2a7d201d1ab423","g":"14054665f49de7d6","name":"Send QUEUE","rules":[{"t":"set","p":"topic","pt":"msg","to":"control","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"queue","tot":"str"}],"x":560,"y":280,"wires":[["fd9c97d92befe581"]]},{"id":"ab40f0da5b7d3c65","type":"inject","z":"9d2a7d201d1ab423","g":"14054665f49de7d6","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":130,"y":260,"wires":[["f1309305071ffa96"]]},{"id":"d4c077d82e686833","type":"inject","z":"9d2a7d201d1ab423","g":"14054665f49de7d6","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"bool","x":130,"y":300,"wires":[["f1309305071ffa96"]]},{"id":"fd9c97d92befe581","type":"q-gate","z":"9d2a7d201d1ab423","g":"14054665f49de7d6","name":"","controlTopic":"control","defaultState":"queueing","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","queueCmd":"queue","defaultCmd":"default","triggerCmd":"trigger","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","statusCmd":"status","maxQueueLength":"0","keepNewest":true,"qToggle":true,"persist":true,"storeName":"default","x":730,"y":260,"wires":[["9799330f7dde46c8"]]},{"id":"ee03dcdf555bcf10","type":"file","z":"9d2a7d201d1ab423","g":"6fa4ad38fcfa7f17","name":"","filename":"/data/nodered/waterLevel","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":570,"y":80,"wires":[[]]},{"id":"b7e957d06335c629","type":"ping","z":"9d2a7d201d1ab423","g":"14054665f49de7d6","protocol":"Automatic","mode":"timed","name":"","host":"google.com","timer":"10","inputs":0,"x":130,"y":220,"wires":[["f1309305071ffa96"]]},{"id":"0d777f479bc1c9e3","type":"file","z":"9d2a7d201d1ab423","g":"6fa4ad38fcfa7f17","name":"","filename":"/data/nodered/distance","filenameType":"str","appendNewline":false,"createDir":false,"overwriteFile":"false","encoding":"none","x":570,"y":120,"wires":[[]]},{"id":"a18495e7155e3671","type":"function","z":"9d2a7d201d1ab423","g":"6fa4ad38fcfa7f17","name":"Water Level Check","func":"// Configuration\nconst COOLDOWN_MS =  5 * 1000 * 60; // Set N duration in milliseconds (e.g., 1000 = 1 second)\nconst GATEWAY = \"00:52:24:23:bf:dc\"; // Set your gateway value (or extract from context/flow)\n\n// Get or initialize last send time in context\nconst lastSendTime = context.get('lastSendTime') || 0;\nconst now = Date.now();\n\n// Check cooldown\nif (now - lastSendTime < COOLDOWN_MS) {\n  // Still in cooldown, drop this message\n  return null;\n}\n\n// Convert ASCII/Buffer input to string\nlet data = msg.payload;\n\nif (Buffer.isBuffer(data)) {\n  data = data.toString('ascii');\n} else {\n  data = String(data);\n}\n\n// Split by newlines and find \"1:*\" entries\nconst lines = data.split(/\\r?\\n/).filter(line => line.trim() !== '');\nconst matched = lines.find(line => line.trim().startsWith(\"1:\"));\n\nif (matched) {\n  // Extract numeric value after \"1:\"\n  const match = matched.trim().match(/^1:(\\d+)/);\n\n  if (match) {\n    const value = parseInt(match[1]);\n\n    // Update last send time\n    context.set('lastSendTime', now);\n\n    // Format output\n    msg.payload = {\n      gateway: GATEWAY,\n      radar: value\n    };\n\n    return msg;\n  }\n}\n\n// No valid \"1:*\" entry found or still in cooldown\nreturn null;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":80,"wires":[["fd9c97d92befe581","ee03dcdf555bcf10"]],"info":"Hereâ€™s a clear, concise explanation of what this Node-RED **function node** code does, line by line, and what the overall logic is.\r\n\r\n---\r\n\r\n# âœ… **Overall Purpose**\r\n\r\nThis function:\r\n\r\n1. Reads incoming serial/Bluetooth/WiFi data.\r\n2. Converts it to text.\r\n3. Extracts a line that starts with `\"1:<number>\"` (e.g. `1:23`).\r\n4. Applies a cooldown so it doesnâ€™t send too many messages.\r\n5. Outputs a **formatted JSON object** `{ gateway: \"...\", radar: value }`.\r\n\r\nIf conditions are not met, it returns `null` (drops the message).\r\n\r\n---\r\n\r\n# ðŸ§© **Detailed Explanation**\r\n\r\n## **1. Configuration**\r\n\r\n```js\r\nconst COOLDOWN_MS =  5 * 1000;\r\nconst GATEWAY = \"00:52:24:23:bf:dc\";\r\n```\r\n\r\n* `COOLDOWN_MS` = how long to wait before the next message is allowed (5 seconds).\r\n* `GATEWAY` = an identifier added to the output payload.\r\n\r\n---\r\n\r\n## **2. Cooldown logic**\r\n\r\n```js\r\nconst lastSendTime = context.get('lastSendTime') || 0;\r\nconst now = Date.now();\r\n\r\nif (now - lastSendTime < COOLDOWN_MS) {\r\n  return null;\r\n}\r\n```\r\n\r\n* Reads the previous send time from **Node-RED context storage**.\r\n* If not enough time has passed â†’ **drop the message**.\r\n* This prevents spamming output.\r\n\r\n---\r\n\r\n## **3. Convert payload to string**\r\n\r\n```js\r\nlet data = msg.payload;\r\n\r\nif (Buffer.isBuffer(data)) {\r\n  data = data.toString('ascii');\r\n} else {\r\n  data = String(data);\r\n}\r\n```\r\n\r\nEnsures the input becomes a **plain ASCII string**, whether it comes as:\r\n\r\n* a Buffer (from serial/Bluetooth sensors)\r\n* a string\r\n* any other type\r\n\r\n---\r\n\r\n## **4. Split lines + find ones starting with `\"1:\"`**\r\n\r\n```js\r\nconst lines = data.split(/\\r?\\n/).filter(line => line.trim() !== '');\r\nconst matched = lines.find(line => line.trim().startsWith(\"1:\"));\r\n```\r\n\r\n* Splits incoming data into lines.\r\n* Finds the **first line that begins with `1:`**.\r\n\r\nExamples matched:\r\n\r\n* `1:234`\r\n* `1:5`\r\n* `1:00045`\r\n\r\n---\r\n\r\n## **5. Extract the numeric value**\r\n\r\n```js\r\nconst match = matched.trim().match(/^1:(\\d+)/);\r\nif (match) {\r\n  const value = parseInt(match[1]);\r\n```\r\n\r\nThis takes `\"1:234\"` and extracts **234**.\r\n\r\n---\r\n\r\n## **6. Store cooldown timestamp**\r\n\r\n```js\r\ncontext.set('lastSendTime', now);\r\n```\r\n\r\nSo the next incoming message wonâ€™t be processed for 5 seconds.\r\n\r\n---\r\n\r\n## **7. Format output**\r\n\r\n```js\r\nmsg.payload = {\r\n  gateway: GATEWAY,\r\n  radar: value\r\n};\r\n\r\nreturn msg;\r\n```\r\n\r\nOutputs a structured payload:\r\n\r\n```json\r\n{\r\n  \"gateway\": \"00:52:24:23:bf:dc\",\r\n  \"radar\": 234\r\n}\r\n```\r\n\r\n---\r\n\r\n## **8. If nothing matches**\r\n\r\n```js\r\nreturn null;\r\n```\r\n\r\nMessage is dropped.\r\n\r\n---\r\n\r\n# ðŸ“˜ **Summary (Simple Version)**\r\n\r\nThis code:\r\n\r\n* Limits outgoing messages (cooldown).\r\n* Reads serial text input.\r\n* Extracts a line like `1:123`.\r\n* Parses the number (`123`).\r\n* Returns JSON: `{ gateway: \"...\", radar: 123 }`.\r\n\r\nIf no match or still in cooldown â†’ **returns nothing**.\r\n\r\n---"},{"id":"c45fd1d35a67803e","type":"debug","z":"9d2a7d201d1ab423","g":"6fa4ad38fcfa7f17","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":310,"y":120,"wires":[]},{"id":"91c8c9203ef24cc4","type":"inject","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","name":"Every 10 min","props":[],"repeat":"600","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":180,"y":80,"wires":[["c3ac1ee5c473a524"]]},{"id":"2a7dcb147e1bce7d","type":"inject","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","name":"Manual snapshot","props":[],"repeat":"","once":false,"onceDelay":0.1,"topic":"","x":180,"y":130,"wires":[["c3ac1ee5c473a524"]]},{"id":"c3ac1ee5c473a524","type":"exec","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","command":"/usr/bin/ffmpeg","addpay":false,"append":"-loglevel error -rtsp_transport tcp -i \"rtsp://admin:P%40jero999@192.168.27.11:554/sub\" -frames:v 1 -f image2pipe -vcodec mjpeg pipe:1","useSpawn":"true","timer":"","winHide":false,"oldrc":false,"name":"ffmpeg â†’ JPEG buffer","x":400,"y":120,"wires":[["27c4b540989b8bb4"],[],[]]},{"id":"27c4b540989b8bb4","type":"function","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","name":"Wrap JSON + Dashboard","func":"if (!Buffer.isBuffer(msg.payload) || msg.payload.length === 0) return null;\n\nconst b64 = msg.payload.toString('base64');\n\n// MQTT JSON\nconst mqtt = {\n  payload: {\n    gateway: \"00:52:24:23:bf:dc\",\n    image_b64: b64\n  }\n};\n\n// Dashboard image (data URL)\nconst dash = {\n  payload: `data:image/jpeg;base64,${b64}`\n};\n\nreturn [dash, mqtt];","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":120,"wires":[["7d08364daae97b02"],["65e5bea195d79742","8399c02ec7e84cd0"]],"info":"if (!Buffer.isBuffer(msg.payload) || msg.payload.length === 0) return null;\n\nconst b64 = msg.payload.toString('base64');\n\n// MQTT JSON\nconst mqtt = {\n  payload: {\n    gateway: \"00:52:24:23:bf:dc\",\n    devType: \"Milesight MS-C2963\",\n    cmd: \"snapshot\",\n    timestamp: Math.floor(Date.now()/1000),\n    contentType: \"image/jpeg\",\n    image_b64: b64\n  }\n};\n\n// Dashboard image (data URL)\nconst dash = {\n  payload: `data:image/jpeg;base64,${b64}`\n};\n\nreturn [dash, mqtt];"},{"id":"65e5bea195d79742","type":"mqtt out","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","name":"","topic":"flood/camera/img","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"ad38133a844d12e3","x":890,"y":120,"wires":[]},{"id":"7c3771ed37a25f87","type":"mqtt in","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","name":"","topic":"flood27/camera/snap","qos":"2","datatype":"auto-detect","broker":"ad38133a844d12e3","nl":false,"rap":true,"rh":0,"inputs":0,"x":160,"y":180,"wires":[["c3ac1ee5c473a524"]]},{"id":"665e5d2798cef93b","type":"inject","z":"aabbaecce1b00e2a","g":"8d52cfa95701d1f6","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":300,"wires":[["d6b682e56e47c08c"]]},{"id":"d6b682e56e47c08c","type":"mqtt out","z":"aabbaecce1b00e2a","g":"8d52cfa95701d1f6","name":"","topic":"flood27/camera/snap","qos":"2","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"ad38133a844d12e3","x":400,"y":300,"wires":[]},{"id":"7d08364daae97b02","type":"ui_template","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","group":"e183b56a98787c57","name":"Snapshot viewer","order":1,"width":8,"height":6,"format":"<div style=\"text-align:center\">\n  <img ng-src=\"{{msg.payload}}\" style=\"max-width:100%; max-height:100%; object-fit:contain; border-radius:8px;\" />\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":890,"y":80,"wires":[[]]},{"id":"8399c02ec7e84cd0","type":"debug","z":"aabbaecce1b00e2a","g":"bb0cc219db80aa46","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":860,"y":160,"wires":[]},{"id":"1","type":"inject","z":"b0eb2326195c59f2","g":"c1f924b2eff6c07a","name":"Play Test Audio","props":[{"p":"payload.value","v":"1","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","x":160,"y":60,"wires":[["a1d841602e6b1968"]]},{"id":"8ae21ac7dbe4b582","type":"mqtt in","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"","topic":"bv27/speaker/speak","qos":"2","datatype":"auto-detect","broker":"ad38133a844d12e3","nl":false,"rap":true,"rh":0,"inputs":0,"x":150,"y":340,"wires":[["7d23a6db0409c5b3","2948eb0d9e3c819f"]]},{"id":"7d23a6db0409c5b3","type":"switch","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Which audio","property":"payload.value","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"eq","v":"4","vt":"str"},{"t":"eq","v":"5","vt":"str"},{"t":"eq","v":"6","vt":"str"},{"t":"eq","v":"7","vt":"str"},{"t":"eq","v":"8","vt":"str"},{"t":"eq","v":"9","vt":"str"},{"t":"eq","v":"10","vt":"str"}],"checkall":"true","repair":false,"outputs":11,"x":370,"y":340,"wires":[["fa2f7ffd6472b54e"],["71664a156fed443c"],["9aec2f9041b3fedc"],["06761c5803b7da94"],["c98f629e0adeb021"],["3bef8afbac187647"],["d0965ccf1ebc3a65"],["03d7fbb3a4decebb"],["970b04d56e4d5a7b"],["4d69b9971b187965"],["15a7048efb16c6a6"]]},{"id":"fa2f7ffd6472b54e","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 0","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=bell1","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":160,"wires":[["ee66ed6c42a9719c","c4e364564139d2b4"]]},{"id":"ee66ed6c42a9719c","type":"debug","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Played","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":790,"y":160,"wires":[]},{"id":"a1d841602e6b1968","type":"mqtt out","z":"b0eb2326195c59f2","g":"c1f924b2eff6c07a","name":"","topic":"bv27/speaker/speak","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"ad38133a844d12e3","x":400,"y":60,"wires":[]},{"id":"71664a156fed443c","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 1","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile1","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":200,"wires":[["ee66ed6c42a9719c"]]},{"id":"9aec2f9041b3fedc","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 2","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile2","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":240,"wires":[["ee66ed6c42a9719c"]]},{"id":"06761c5803b7da94","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 3","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile3","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":280,"wires":[["ee66ed6c42a9719c"]]},{"id":"c98f629e0adeb021","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 4","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile4","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":320,"wires":[["ee66ed6c42a9719c"]]},{"id":"3bef8afbac187647","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 5","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile5","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":360,"wires":[["ee66ed6c42a9719c"]]},{"id":"d0965ccf1ebc3a65","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 6","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile6","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":400,"wires":[["ee66ed6c42a9719c"]]},{"id":"03d7fbb3a4decebb","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 7","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile7","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":440,"wires":[["ee66ed6c42a9719c"]]},{"id":"970b04d56e4d5a7b","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 8","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile8","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":480,"wires":[["ee66ed6c42a9719c"]]},{"id":"4d69b9971b187965","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 9","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile9","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":520,"wires":[["ee66ed6c42a9719c"]]},{"id":"15a7048efb16c6a6","type":"http request","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Play 10","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.26.22/api/play?action=start&file=userfile10","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":600,"y":560,"wires":[["ee66ed6c42a9719c"]]},{"id":"c4e364564139d2b4","type":"function","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Speaker Status","func":"// Build dynamic JSON for \"speak\" command and send to MQTT\n// Only publish if HTTP request was successful.\n//\n// msg.statusCode comes from the HTTP Request node\n// (200 = OK, 2xx = success)\n\nconst DEFAULTS = {\n    gateway: \"a0:19:b2:d2:7a:e4\",\n    devType: \"IP-Speaker\",\n    cmd: \"speak\",\n    topic: \"bv27/speaker/speak\"\n};\n\n// Only continue if HTTP status indicates success\nif (msg.statusCode && msg.statusCode >= 200 && msg.statusCode < 300) {\n    msg.topic = msg.topic || DEFAULTS.topic;\n    msg.payload = {\n        gateway: msg.gateway || DEFAULTS.gateway,\n        devType: msg.devType || DEFAULTS.devType,\n        cmd: msg.cmd || DEFAULTS.cmd,\n        timestamp: Math.floor(Date.now() / 1000),\n        value: msg.value || 1   // default = 1 if not provided\n    };\n    return msg;   // âœ… success â†’ send to MQTT\n} else {\n    // âŒ failed request â†’ don't publish\n    node.warn(\"Web request failed: \" + msg.statusCode);\n    return null;  // stops the message here\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":320,"wires":[["51a3da1b50ecd7b1","98bb99a91bc910d2"]]},{"id":"51a3da1b50ecd7b1","type":"debug","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Speaker Debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":860,"y":280,"wires":[]},{"id":"98bb99a91bc910d2","type":"mqtt out","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"ad38133a844d12e3","x":850,"y":360,"wires":[]},{"id":"2948eb0d9e3c819f","type":"debug","z":"b0eb2326195c59f2","g":"89f6554eadeaf202","name":"Inject Debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":190,"y":300,"wires":[]},{"id":"5f7aa11225841d0b","type":"mqtt out","z":"d3dfdfd513fb0aa2","g":"9b60db2e6429cd60","name":"","topic":"flood/solar/data","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"ad38133a844d12e3","x":860,"y":60,"wires":[]},{"id":"7708ede44e016d0a","type":"function","z":"d3dfdfd513fb0aa2","d":true,"g":"1bbb998942558785","name":"","func":"// Input buffer\nlet buffer = msg.payload; // Assuming msg.payload contains the buffer data\n\n// Check if buffer has at least 55 elements (buffer[54] exists)\nif (buffer && buffer.length > 53) {\n    // Decode the buffer into the desired JSON format\n    msg.payload = {\n        deveui: \"0000000000000001\",\n        ipAdress: \"http://192.168.12.1\", // Static value, replace as needed\n        devicename: \"elastel\",  // Static value, replace as needed\n        timestamp: Date.now(), // Current timestamp in milliseconds\n        alarmInformation: (buffer[15] << 8) | buffer[16], // 16-bit value\n        batteryChargingCurrent: ((buffer[27] << 8) | buffer[28]) / 100, // 16-bit value, scaled by 100\n        batteryDischargeCurrent: ((buffer[29] << 8) | buffer[30]) / 100, // 16-bit value, scaled by 100\n        batteryPower: ((buffer[21] << 8) | buffer[22]), // 16-bit value, scaled by 10\n        batterySoC: buffer[19], // 8-bit value\n        clampingVoltage: ((buffer[47] << 8) | buffer[48]) / 10, // 16-bit value, scaled by 10\n        controlInformation: (buffer[11] << 8) | buffer[12], // Example static value, replace if dynamic\n        internalTimestampHigh: ((buffer[49] << 8) | buffer[50]), // 16-bit value\n        internalTimestampLow: ((buffer[51] << 8) | buffer[52]), // 16-bit value\n        remainingAH: ((buffer[17] << 8) | buffer[18]) / 10, // 16-bit value, scaled by 10\n        remainingDays: ((buffer[52] << 8) | buffer[53]) / 100, // 16-bit value, scaled by 100\n        temperatures1: buffer[31], // 8-bit value\n        temperatures2: buffer[32], // 8-bit value\n        totalBatteryCurrent: ((buffer[25] << 8) | buffer[26]) / 10, // 16-bit value, scaled by 10\n        totalBatteryVoltage: ((buffer[23] << 8) | buffer[24]) / 10, // 16-bit value, scaled by 10\n        humidity: buffer[20]\n    };\n} else {\n    // If buffer[54] doesn't exist, return an empty message or a warning\n    msg.payload = { error: \"Buffer length is insufficient\" };\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":480,"wires":[["a01ae8ea72715992"]]},{"id":"a01ae8ea72715992","type":"debug","z":"d3dfdfd513fb0aa2","d":true,"g":"1bbb998942558785","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":370,"y":480,"wires":[]},{"id":"ff4e245b16e85dab","type":"function","z":"d3dfdfd513fb0aa2","g":"9b60db2e6429cd60","name":"BUF2HEX","func":"\n// Input buffer\nlet buffer = msg.payload; // Assuming msg.payload contains the buffer data\n\n// Convert buffer to an array of hex values\nlet hexArray = Array.from(buffer, byte => byte.toString(16).padStart(2, '0'));\n\n// Construct the output\nmsg.payload = {\n    // originalBuffer: buffer,\n    hexRepresentation: hexArray.join(\" \") // Combine hex values into a single string\n};\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":60,"wires":[["5cfb238b3a200525"]]},{"id":"e563708f3023885b","type":"function","z":"d3dfdfd513fb0aa2","d":true,"g":"1bbb998942558785","name":"Full-Decode-based-docs","func":"let buffer = msg.payload;\n\nbuffer = buffer.slice(11, 62)\n\nfunction toHex(num) {\n    return \"0x\" + num.toString(16).padStart(2, '0').toUpperCase();\n}\n\n// Protocol fields remain in hex\nlet startFlag = toHex(buffer[0]);\nlet headerInfo = toHex(buffer[1]);\nlet controlInfo = toHex(buffer[2]);\nlet messageLength = toHex(buffer[3]);\nlet fragmentOffset = toHex((buffer[4] << 8) | buffer[5]);\nlet commandData = toHex(buffer[6]);\nlet commandBytes = [toHex(buffer[7]), toHex(buffer[8]), toHex(buffer[9])];\nlet errorCode = toHex(buffer[10]);\nlet functionCode = toHex(buffer[11]);\nlet startAddress = toHex((buffer[12] << 8) | buffer[13]);\nlet registerCount = toHex(buffer[14]);\n\n// Battery data all in decimal\nlet alarmInformation = (buffer[15] << 8) | buffer[16];\nlet remainingAH = ((buffer[17] << 8) | buffer[18]) / 10;\nlet batterySoC = buffer[19];\nlet humidity = buffer[20];\nlet batteryPower = (buffer[21] << 8) | buffer[22];\nlet totalBatteryVoltage = ((buffer[23] << 8) | buffer[24]) / 10;\nlet totalBatteryCurrent = ((buffer[25] << 8) | buffer[26]) / 10;\nlet batteryChargingCurrent = ((buffer[27] << 8) | buffer[28]) / 100;\nlet batteryDischargeCurrent = ((buffer[29] << 8) | buffer[30]) / 100;\n\n// Temperature readings - convert to decimal except \"Not installed\"\nlet temperatures = [];\nfor (let i = 0; i < 8; i++) {\n    let temp1 = buffer[31 + i * 2];\n    let temp2 = buffer[32 + i * 2];\n    temperatures.push({\n        temp1: temp1 === 0xCE ? \"Not installed\" : temp1,\n        temp2: temp2 === 0xCE ? \"Not installed\" : temp2\n    });\n}\n\n// CRC and end flag remain in hex\nlet crc = toHex((buffer[buffer.length - 3] << 8) | buffer[buffer.length - 2]);\nlet endFlag = toHex(buffer[buffer.length - 1]);\n\nmsg.payload = {\n    protocol: {\n        startFlag: startFlag,\n        headerInfo: headerInfo,\n        controlInfo: controlInfo,\n        messageLength: messageLength,\n        fragmentOffset: fragmentOffset,\n        commandData: commandData,\n        commandBytes: commandBytes,\n        errorCode: errorCode,\n        functionCode: functionCode,\n        startAddress: startAddress,\n        registerCount: registerCount\n    },\n    batteryData: {\n        alarmInformation: alarmInformation,\n        remainingAH: remainingAH,\n        batterySoC: batterySoC,\n        humidity: humidity,\n        batteryPower: batteryPower,\n        totalBatteryVoltage: totalBatteryVoltage,\n        totalBatteryCurrent: totalBatteryCurrent,\n        batteryChargingCurrent: batteryChargingCurrent,\n        batteryDischargeCurrent: batteryDischargeCurrent,\n        temperatures: temperatures\n    },\n    verification: {\n        crc: crc,\n        endFlag: endFlag\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":600,"wires":[["eec3995c4100cde7"]]},{"id":"f69ef20e49fd5e67","type":"function","z":"d3dfdfd513fb0aa2","g":"8f1bccb954c87175","name":"Read-Command","func":"// Define the command to request 22 registers starting from 0x200\n// let commandHex = \"41160F0100009D0A0B0B04020016211A2B\";\nlet commandHex = \"41160F0100003A0A0B0B0402021221B92B\"\n\n// Convert the hex string to a Buffer object\nmsg.payload = Buffer.from(commandHex, 'hex');\n\n// Send the command to the serial out node\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":160,"wires":[["0870edf5488db2a6"]]},{"id":"ae3ca7f3c39fa801","type":"inject","z":"d3dfdfd513fb0aa2","g":"8f1bccb954c87175","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"*/15 0-23 * * *","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":170,"y":160,"wires":[["f69ef20e49fd5e67"]]},{"id":"eec3995c4100cde7","type":"debug","z":"d3dfdfd513fb0aa2","d":true,"g":"1bbb998942558785","name":"debug 9","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":440,"y":600,"wires":[]},{"id":"80565d49ed58925c","type":"function","z":"d3dfdfd513fb0aa2","d":true,"g":"1bbb998942558785","name":"batteryData Decode","func":"let buffer = msg.payload;\n\nbuffer = buffer.slice(0,61);\n// Function to convert numbers to hex format\nfunction toHex(num) {\n    return \"0x\" + num.toString(16).padStart(2, '0').toUpperCase();\n}\n\n// Convert 16-bit value to signed int16 using two's complement\nfunction toInt16(highByte, lowByte) {\n    let value = (highByte << 8) | lowByte;\n    return value > 0x7FFF ? value - 0x10000 : value;\n}\n\n// // Check if buffer length matches expected size\n// if (buffer.length !== 63) {\n//     node.warn(\"Buffer length is not 54. Passing message without decoding.\");\n//     return msg; // Pass through without changes\n// }\n\n// Decode protocol fields\nlet startFlag = toHex(buffer[0]);\nlet headerInfo = toHex(buffer[1]);\nlet controlInfo = toHex(buffer[2]);\nlet messageLength = toHex(buffer[3]);\nlet fragmentOffset = toHex((buffer[4] << 8) | buffer[5]);\nlet commandData = toHex(buffer[6]);\nlet commandBytes = [toHex(buffer[7]), toHex(buffer[8]), toHex(buffer[9])];\nlet errorCode = toHex(buffer[10]);\nlet functionCode = toHex(buffer[11]);\nlet startAddress = toHex((buffer[12] << 8) | buffer[13]);\nlet registerCount = toHex(buffer[14]);\n\n// Battery data\nlet alarmInformation = (buffer[15] << 8) | buffer[16];\nlet remainingAH = ((buffer[17] << 8) | buffer[18]) / 10;\nlet batterySoC = buffer[19];\nlet humidity = buffer[20];\nlet batteryPower = toInt16(buffer[21], buffer[22]);\nlet totalBatteryVoltage = ((buffer[23] << 8) | buffer[24]) / 10;\n// Convert currents to signed values\nlet totalBatteryCurrent = toInt16(buffer[25], buffer[26]) / 10;\nlet batteryChargingCurrent = toInt16(buffer[27], buffer[28]) / 100;\nlet batteryDischargeCurrent = toInt16(buffer[29], buffer[30]) / 100;\n\n// Extract first temperature pair\nlet temp1 = buffer[31] === 0xCE ? \"Not installed\" : buffer[31];\nlet temp2 = buffer[32] === 0xCE ? \"Not installed\" : buffer[32];\n\n// CRC and end flag remain in hex\nlet crc = toHex((buffer[buffer.length - 3] << 8) | buffer[buffer.length - 2]);\nlet endFlag = toHex(buffer[buffer.length - 1]);\n\n// Calculate net discharge current\nlet netDischargeCurrent = batteryDischargeCurrent - batteryChargingCurrent; // Net discharge current in A\n\n// Check if net discharge current is positive (battery is discharging)\nif (netDischargeCurrent > 0) {\n    // Calculate remaining hours and days based on real-time values\n    let remainingHours = remainingAH / netDischargeCurrent; // Remaining hours\n    let remainingDays = remainingHours / 24; // Remaining days\n\n    // Add calculated values to payload\n    msg.payload = {\n        batteryData: {\n            deveui: \"0000000000000001\",\n            ipAdress: \"http://192.168.12.254\",\n            devicename: \"elastel\",\n            alarmInformation: alarmInformation,\n            remainingAH: remainingAH,\n            batterySoC: batterySoC,\n            // humidity: humidity,\n            batteryPower: batteryPower,\n            totalBatteryVoltage: totalBatteryVoltage,\n            totalBatteryCurrent: totalBatteryCurrent,\n            batteryChargingCurrent: batteryChargingCurrent,\n            batteryDischargeCurrent: batteryDischargeCurrent,\n            temperatures1: temp1,\n            temperatures2: temp2,\n            remainingHours: remainingHours.toFixed(2), // Rounded to 2 decimal places\n            remainingDays: remainingDays.toFixed(2)  // Rounded to 2 decimal places\n        }\n    };\n} else {\n    // If the net discharge current is 0 or negative (charging or no load), display \"N/A\"\n    node.warn(\"Net discharge current is zero or negative, unable to calculate remaining life.\");\n    msg.payload = {\n        batteryData: {\n            deveui: \"0000000000000001\",\n            ipAdress: \"http://192.168.12.254\",\n            devicename: \"elastel\",\n            alarmInformation: alarmInformation,\n            remainingAH: remainingAH,\n            batterySoC: batterySoC,\n            // humidity: humidity,\n            batteryPower: batteryPower,\n            totalBatteryVoltage: totalBatteryVoltage,\n            totalBatteryCurrent: totalBatteryCurrent,\n            batteryChargingCurrent: batteryChargingCurrent,\n            batteryDischargeCurrent: batteryDischargeCurrent,\n            temperatures1: temp1,\n            temperatures2: temp2,\n            remainingHours: \"N/A\",\n            remainingDays: \"N/A\"\n        }\n    };\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":540,"wires":[["1be0298cc11e5371"]]},{"id":"1be0298cc11e5371","type":"debug","z":"d3dfdfd513fb0aa2","d":true,"g":"1bbb998942558785","name":"debug 10","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":400,"y":540,"wires":[]},{"id":"5cfb238b3a200525","type":"function","z":"d3dfdfd513fb0aa2","g":"9b60db2e6429cd60","name":"Battery Parser","func":"function decodeData(msg) {\n    const hexData = msg.payload.hexRepresentation.replace(/ /g, '');\n    const dataStart = 30;\n    const data = hexData.substring(dataStart);\n\n    function hexToDec(hex) {\n        if (!hex) return 0;\n        return parseInt(hex, 16);\n    }\n\n    // Function to convert hex to signed int8\n    function hexToSignedInt8(hex) {\n        let value = parseInt(hex, 16);\n        // Convert to signed 8-bit\n        if (value > 127) {\n            value = value - 256;\n        }\n        return value;\n    }\n\n    try {\n        // Decode temperatures (2*sint8 format)\n        // 0x020A is temp1/temp2\n        const temp1 = hexToSignedInt8(data.substring(32, 34)); // First byte\n        const temp2 = hexToSignedInt8(data.substring(34, 36)); // Second byte\n\n        // First decode all values\n        const remainingAh = (hexToDec(data.substring(4, 8)) / 10);\n        const dischargeCurrent = (hexToDec(data.substring(28, 32)) / 100);\n        const chargingCurrent = (hexToDec(data.substring(24, 28)) / 100);\n\n        // Calculate net discharge current\n        const netDischargeCurrent = parseFloat(dischargeCurrent) - parseFloat(chargingCurrent);\n\n        // Initialize remaining time values\n        let remainingHours = \"N/A\";\n        let remainingDays = 0;\n\n        // Calculate remaining time if discharging\n        if (netDischargeCurrent > 0) {\n            remainingHours = (parseFloat(remainingAh) / netDischargeCurrent).toFixed(2);\n            remainingDays = (parseFloat(remainingHours) / 24).toFixed(2);\n        }\n\n        // Create payload\n        msg.payload = {\n            gateway: \"00:52:24:23:bf:dc\",\n            ipAdress: \"192.168.27.1\",\n            devicename: \"bivocom\",\n            deviceData : \"solar data\",\n            alarm: hexToDec(data.substring(0, 4)),\n            remainingAh: remainingAh,\n            batterySoc: hexToDec(data.substring(8, 10)),\n            humidity: hexToDec(data.substring(10, 12)),\n            batteryPower: hexToDec(data.substring(12, 16)),\n            totalBatteryVoltage: (hexToDec(data.substring(16, 20)) / 10),\n            totalBatteryCurrent: ((hexToDec(data.substring(20, 24)) << 16 >> 16) / 10),\n            batteryChargingCurrent: chargingCurrent,\n            batteryDischargeCurrent: dischargeCurrent,\n            temperatures1: temp1,\n            temperatures2: temp2,\n            remainingHours: remainingHours,\n            remainingDays: remainingDays\n        };\n\n        return msg;\n\n    } catch (error) {\n        node.error(\"Error decoding data: \" + error.message);\n        return null;\n    }\n}\n\nreturn decodeData(msg);","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":60,"wires":[["b2f915bd6db41bb9"]]},{"id":"49e26240e82539d0","type":"serial in","z":"d3dfdfd513fb0aa2","g":"9b60db2e6429cd60","name":"","serial":"7459e1c0f90208e3","x":160,"y":60,"wires":[["ff4e245b16e85dab"]]},{"id":"0870edf5488db2a6","type":"serial out","z":"d3dfdfd513fb0aa2","g":"8f1bccb954c87175","name":"","serial":"7459e1c0f90208e3","x":520,"y":160,"wires":[]},{"id":"b2f915bd6db41bb9","type":"function","z":"d3dfdfd513fb0aa2","g":"9b60db2e6429cd60","name":"function 7","func":"let payload = msg.payload;\n\nconst MPPT_EFFICIENCY = 0.95;\n\n// 1. Total energy discharge\npayload.totalEnergyDischarge = payload.batteryDischargeCurrent * payload.totalBatteryVoltage;\n\n// 2. Total energy charge\npayload.totalEnergyCharge = payload.batteryChargingCurrent * payload.totalBatteryVoltage;\n\n// 3. Dynamic solar panel voltage (calculated from power)\nlet solarPower = (payload.totalBatteryVoltage * payload.batteryChargingCurrent) / MPPT_EFFICIENCY;\npayload.solarPanelVoltage = (payload.batteryChargingCurrent > 0)\n    ? (solarPower / payload.batteryChargingCurrent)\n    : 0;\n\nmsg.payload = payload;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":60,"wires":[["5f7aa11225841d0b","18b80fe4fca895af"]]},{"id":"18b80fe4fca895af","type":"debug","z":"d3dfdfd513fb0aa2","g":"9b60db2e6429cd60","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1050,"y":60,"wires":[]},{"id":"30eaf86bb2bab5c7","type":"inject","z":"9071ee17a216293a","g":"109a5214842acafe","name":"Periodic Inject","props":[],"repeat":"300","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":180,"y":80,"wires":[["0778cb410aee5bbe"]]},{"id":"5758f65c54c6980e","type":"serial request","z":"9071ee17a216293a","g":"109a5214842acafe","name":"","serial":"9e490f20ec5dd3a7","x":510,"y":80,"wires":[["5c1390e8081212b4","3caa94c6a1b78abf"]]},{"id":"319c1fe4768ca6de","type":"mqtt out","z":"9071ee17a216293a","g":"109a5214842acafe","name":"","topic":"flood/rain/data","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"ad38133a844d12e3","x":1040,"y":80,"wires":[]},{"id":"5c1390e8081212b4","type":"file","z":"9071ee17a216293a","g":"109a5214842acafe","name":"","filename":"/data/nodered/tipping","filenameType":"str","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":720,"y":140,"wires":[[]]},{"id":"678bf8127f6fc8e5","type":"serial out","z":"9071ee17a216293a","g":"109a5214842acafe","name":"","serial":"9e490f20ec5dd3a7","x":1030,"y":140,"wires":[]},{"id":"0778cb410aee5bbe","type":"function","z":"9071ee17a216293a","g":"109a5214842acafe","name":"READ","func":"// RS-FYLGZ-N01-1-EX  - Read Rainfall Register 0x0000\n// Modbus RTU frame: 01 03 00 00 00 01 84 0A\n\nfunction crc16(bytes) {\n    let crc = 0xFFFF;\n    for (let b of bytes) {\n        crc ^= b;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc & 1) ? (crc >> 1) ^ 0xA001 : (crc >> 1);\n        }\n    }\n    return crc;\n}\n\nconst slave = msg.slave || 0x01;\nconst frame = [slave, 0x03, 0x00, 0x00, 0x00, 0x01];\nconst crc = crc16(frame);\n\nframe.push(crc & 0xFF);      // CRC Lo\nframe.push((crc >> 8) & 0xFF); // CRC Hi\n\nmsg.payload = Buffer.from(frame);\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":80,"wires":[["5758f65c54c6980e"]]},{"id":"3caa94c6a1b78abf","type":"function","z":"9071ee17a216293a","g":"109a5214842acafe","name":"PARSE","func":"// Combined Parser + MQTT Payload Builder\n// RS-FYLGZ-N01-1-EX Optical Rain + Light Sensor\n\n// -------- CONFIG --------\nconst GATEWAY = \"00:52:24:23:bf:dc\";   // <<--- CHANGE THIS TO YOUR DEVICE ID\n\n// -------- CRC CHECK --------\nfunction crc16(data) {\n    let crc = 0xFFFF;\n    for (let byte of data) {\n        crc ^= byte;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    return crc;\n}\n\n// -------- NORMALIZE INPUT --------\nlet buf;\nif (Buffer.isBuffer(msg.payload)) buf = [...msg.payload];\nelse if (Array.isArray(msg.payload)) buf = msg.payload;\nelse return null;\n\n// -------- BASIC VALIDATION --------\nif (buf.length < 5) return null;\n\n// CRC check\nconst calc = crc16(buf.slice(0, buf.length - 2));\nconst recv = buf[buf.length - 2] | (buf[buf.length - 1] << 8);\nif (calc !== recv) return null;\n\nconst fn = buf[1];\nif (fn & 0x80) return null;   // Modbus exception\n\nconst byteCount = buf[2];\nconst data = buf.slice(3, 3 + byteCount);\n\n// -------- PARSING --------\nlet rain_mm = 0;\n\n// RAINFALL: register 0x0000 â†’ 2 bytes â†’ raw/10\nif (byteCount === 2) {\n    const rawRain = (data[0] << 8) | data[1];\n    rain_mm = rawRain / 10.0;\n}\n\n// -------- MQTT PAYLOAD --------\nmsg.payload = {\n    gateway: GATEWAY,\n    tip: rain_mm\n};\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":80,"wires":[["c76ddac70a4b7e18","a8fbdcd184af7480"]],"info":"---\n\n# âœ… **Overall Purpose**\n\nThis Node-RED function:\n\n1. Accepts a Modbus RTU response (Buffer or byte array).\n2. Validates it (CRC check, exception check).\n3. Extracts the rainfall value from register data.\n4. Converts it to **millimeters**.\n5. Outputs a clean MQTT-ready object:\n\n```json\n{\n  \"gateway\": \"00:52:24:23:bf:dc\",\n  \"tip\": 12.3\n}\n```\n\nIf anything is invalid â†’ it returns:\n\n```json\n{ \"gateway\": \"...\", \"tip\": 0 }\n```\n\n---\n\n# ðŸ§© **Line-by-Line Explanation**\n\n---\n\n# **1. Configuration**\n\n```js\nconst GATEWAY = msg.gateway || flow.get(\"GATEWAY\") || \"00:52:24:23:bf:dc\";\n```\n\n* Uses `msg.gateway` if present.\n* Falls back to a stored flow variable.\n* Otherwise uses a default gateway ID.\n\n---\n\n# **2. Convert input to a byte array**\n\n```js\nif (Buffer.isBuffer(msg.payload)) {\n    buffer = Array.from(msg.payload);\n} else if (Array.isArray(msg.payload)) {\n    buffer = msg.payload;\n} else {\n    msg.payload = { gateway: GATEWAY, tip: 0 };\n    return msg;\n}\n```\n\nAccepts:\n\n* Buffer\n* Array\n\nRejects anything else.\n\n---\n\n# **3. CRC-16 verification**\n\n```js\nfunction verifyCRC(data) {\n    ...\n    const receivedCRC = data[data.length - 2] | (data[data.length - 1] << 8);\n    return crc === receivedCRC;\n}\n```\n\n* Calculates CRC16 (Modbus polynomial 0xA001).\n* Compares it with the last 2 bytes of the frame.\n* Returns **true** if valid.\n\n---\n\n# **4. Check minimum frame size**\n\n```js\nif (buffer.length < 4) {\n    msg.payload = { gateway: GATEWAY, tip: 0 };\n    return msg;\n}\n```\n\nA valid Modbus frame must be at least:\n\n```\n[slave][function][byte count][data][CRC low][CRC high]\n```\n\n---\n\n# **5. Extract address + function code**\n\n```js\nconst slaveAddress = buffer[0];\nconst functionCode = buffer[1];\n```\n\n---\n\n# **6. Handle Modbus exception responses**\n\nIf function code has bit 7 set (0x80 â†’ error):\n\n```js\nif (functionCode & 0x80) {\n    msg.payload = { gateway: GATEWAY, tip: 0 };\n    return msg;\n}\n```\n\nExample exception:\n\n```\n01 83 02 CRC_L CRC_H\n```\n\n---\n\n# **7. Perform CRC validation**\n\n```js\nif (!verifyCRC(buffer)) {\n    msg.payload = { gateway: GATEWAY, tip: 0 };\n    return msg;\n}\n```\n\nIf CRC is wrong â†’ drop.\n\n---\n\n# **8. Parse normal Modbus response**\n\nSupports FC 03 or 04:\n\n```js\nif (functionCode === 0x03 || functionCode === 0x04) {\n```\n\nThen checks:\n\n```js\nconst byteCount = buffer[2];\nif (byteCount >= 2 && buffer.length >= 5) {\n```\n\nData ordering:\n\n```\n[0] Slave\n[1] Function\n[2] Byte count\n[3] Data high byte\n[4] Data low byte\n[5] CRC low\n[6] CRC high\n```\n\n---\n\n# **9. Extract rainfall register**\n\n```js\nconst rawValue = (buffer[3] << 8) | buffer[4];\nconst currentRainfallMM = rawValue / 10.0;\n```\n\nMeaning:\n\n* Device returns rainfall x 10\n  Example: device returns `0123` â†’ actual rainfall = `12.3 mm`\n\n---\n\n# **10. Create final output**\n\n```js\nmsg.payload = {\n    gateway: GATEWAY,\n    tip: currentRainfallMM\n};\n```\n\nThis is the object you will publish to MQTT.\n\n---\n\n# **11. Default fallback**\n\nIf the response is valid but not recognized:\n\n```js\nmsg.payload = { gateway: GATEWAY, tip: 0 };\n```\n\n---\n\n# ðŸ“Œ **Summary**\n\n### This script:\n\nâœ” Accepts Modbus RTU buffer\nâœ” Validates CRC\nâœ” Handles Modbus exception frames\nâœ” Parses data from FC=03 or FC=04\nâœ” Converts register reading to mm\nâœ” Outputs clean MQTT JSON\n\n### Typical output:\n\n```json\n{\n  \"gateway\": \"00:52:24:23:bf:dc\",\n  \"tip\": 4.5\n}\n```\n\n---"},{"id":"c76ddac70a4b7e18","type":"debug","z":"9071ee17a216293a","g":"109a5214842acafe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1050,"y":80,"wires":[]},{"id":"a8fbdcd184af7480","type":"function","z":"9071ee17a216293a","g":"109a5214842acafe","name":"RAIN LOGIC","func":"// Rain Logic node\n// Inputs: msg.payload.gateway (string) and msg.payload.tip (number = rain_mm)\n// Outputs: [ mqttMsg, clearCmdMsg ]\n//\n// Configurable params:\nconst RAIN_SEND_MINUTES = flow.get('RAIN_SEND_MINUTES') || 5;      // N minutes while raining (default 1) - change as needed\nconst STOP_THRESHOLD_MINUTES = flow.get('STOP_THRESHOLD_MINUTES') || 5; // minutes without increase => stopped\nconst IDLE_SEND_MINUTES = 10; // publish interval when idle (non-raining)\nconst GATEWAY_ID_DEFAULT = \"00:52:24:23:bf:dc\"; // fallback gateway id\n\n// Helpers: CRC16 (Modbus A001)\nfunction crc16(bytes) {\n    let crc = 0xFFFF;\n    for (let b of bytes) {\n        crc ^= (b & 0xFF);\n        for (let i = 0; i < 8; i++) {\n            if ((crc & 0x0001) !== 0) crc = (crc >> 1) ^ 0xA001;\n            else crc = crc >> 1;\n        }\n    }\n    return crc & 0xFFFF;\n}\n\n// Build CLEAR frame for device (01 06 00 00 00 5A + CRC)\nfunction buildClearFrame(slaveAddr = 0x01) {\n    const frame = [slaveAddr & 0xFF, 0x06, 0x00, 0x00, 0x00, 0x5A];\n    const crc = crc16(frame);\n    frame.push(crc & 0xFF);          // CRC Lo\n    frame.push((crc >> 8) & 0xFF);   // CRC Hi\n    return Buffer.from(frame);\n}\n\n// Validate input\nif (!msg.payload || (typeof msg.payload.tip === 'undefined' && typeof msg.payload.rain_mm === 'undefined')) {\n    // nothing to do\n    return null;\n}\n\n// normalize fields\nconst now = Date.now();\nconst tipVal = (typeof msg.payload.tip !== 'undefined') ? Number(msg.payload.tip) :\n    (typeof msg.payload.rain_mm !== 'undefined') ? Number(msg.payload.rain_mm) : 0;\nconst gateway = msg.payload.gateway || GATEWAY_ID_DEFAULT;\n\n// State stored in flow context (survives node restart within same session)\nconst ctx = flow.get('rainLogic') || {\n    lastTip: 0,\n    lastTipTime: 0,      // last time tip increased\n    lastSentTime: 0,     // last time we published MQTT\n    raining: false,\n    clearSent: false     // whether we already sent CLEAR on stop transition\n};\n\n// Detect increase\nif (tipVal > ctx.lastTip) {\n    ctx.lastTip = tipVal;\n    ctx.lastTipTime = now;\n    // when an increase happens, we definitely consider it raining\n    ctx.raining = true;\n    ctx.clearSent = false; // reset clear flag because raining again\n}\n\n// Determine if raining has stopped:\n// If no increase for STOP_THRESHOLD_MINUTES -> consider stopped\nconst noIncreaseDurationMs = now - (ctx.lastTipTime || 0);\nconst stopThresholdMs = STOP_THRESHOLD_MINUTES * 60 * 1000;\nconst rainingNow = (ctx.raining && (noIncreaseDurationMs <= stopThresholdMs)) || (tipVal > 0 && (now - ctx.lastTipTime) < 1000);\n\n// If previously raining but now exceeded threshold -> transition to stopped\nlet willSendClear = false;\nif (ctx.raining && noIncreaseDurationMs > stopThresholdMs) {\n    // transition: raining -> stopped\n    ctx.raining = false;\n    if (!ctx.clearSent) {\n        willSendClear = true;\n        ctx.clearSent = true; // ensure we only send clear once\n    }\n}\n\n// Decide publish intervals\nconst rainIntervalMs = RAIN_SEND_MINUTES * 60 * 1000;\nconst idleIntervalMs = IDLE_SEND_MINUTES * 60 * 1000;\n\nlet shouldPublish = false;\nif (ctx.raining) {\n    // while raining: publish every RAIN_SEND_MINUTES\n    if (!ctx.lastSentTime || (now - ctx.lastSentTime) >= rainIntervalMs) shouldPublish = true;\n} else {\n    // idle: publish every IDLE_SEND_MINUTES\n    if (!ctx.lastSentTime || (now - ctx.lastSentTime) >= idleIntervalMs) shouldPublish = true;\n}\n\n// Build MQTT payload if publishing\nlet mqttMsg = null;\nif (shouldPublish) {\n    mqttMsg = {\n        payload: {\n            gateway: gateway,\n            tip: tipVal\n        }\n    };\n    ctx.lastSentTime = now;\n}\n\n// Build clear command if needed\nlet clearMsg = null;\nif (willSendClear) {\n    // Write clear frame to serial out\n    const slave = Number(flow.get('MODBUS_SLAVE') || 1);\n    const frame = buildClearFrame(slave);\n    clearMsg = { payload: frame };\n}\n\n// Save state\nflow.set('rainLogic', ctx);\n\n// Return outputs: [ mqttMsg, clearMsg ]\nreturn [mqttMsg, clearMsg];\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":80,"wires":[["319c1fe4768ca6de"],["678bf8127f6fc8e5"]]},{"id":"5eda1f1fec01f237","type":"global-config","env":[],"modules":{"node-red-node-serialport":"2.0.3","node-red-dashboard":"3.6.6","node-red-contrib-queue-gate":"1.5.5","node-red-node-ping":"0.3.3"}}]
